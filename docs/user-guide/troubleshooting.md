# 🔧 故障排除

麦咪遇到问题了吗？不用担心，这里有完整的解决方案喵♡～

## 🚨 常见问题与解决方案

### 🔴 消息转发相关问题

#### 问题1: 消息没有被转发

**症状**: 设置了监听和目标，但消息不转发

**可能原因**:
1. 消息阈值未达到
2. 任务被禁用
3. 会话ID配置错误
4. 权限不足

**排查步骤**:
```bash
# 1. 检查任务状态
/turnrig status 任务ID

# 2. 查看是否达到阈值
/turnrig list

# 3. 手动触发转发测试
/turnrig forward 任务ID

# 4. 检查任务是否启用
/turnrig enable 任务ID
```

**解决方案**:
- 降低消息阈值: `/turnrig threshold 任务ID 1`
- 确保任务启用: `/turnrig enable 任务ID`
- 检查会话ID格式是否正确
- 确保机器人有发送消息权限

#### 问题2: 只有部分消息被转发

**症状**: 有些消息转发了，有些没有

**可能原因**:
1. 消息重复检测机制
2. 机器人消息被过滤
3. 特定用户监听配置

**解决方案**:
```bash
# 检查机器人过滤列表
/turnrig listbots

# 检查是否配置了特定用户监听
/turnrig status 任务ID
```

#### 问题3: 转发延迟过长

**症状**: 消息很久才被转发

**可能原因**:
1. 消息阈值设置过高
2. 监听的群聊活跃度低

**解决方案**:
```bash
# 降低消息阈值
/turnrig threshold 任务ID 5

# 或设置为即时转发
/turnrig threshold 任务ID 1
```

### 🔴 权限相关问题

#### 问题4: "只有管理员才能执行此操作"

**症状**: 执行命令时显示权限错误

**解决方案**:
1. 确保你是AstrBot的管理员
2. 检查AstrBot的管理员配置
3. 联系AstrBot管理员添加权限

#### 问题5: 机器人无法发送消息

**症状**: 插件运行正常但无法在目标群发送消息

**解决方案**:
1. 确保机器人在目标群聊中
2. 检查机器人在群中的权限
3. 确认群聊没有设置发言限制
4. 检查QQ账号状态是否正常

### 🔴 配置相关问题

#### 问题6: "任务ID不存在"

**症状**: 使用命令时提示任务不存在

**解决方案**:
```bash
# 查看所有现有任务
/turnrig list

# 使用正确的任务ID（通常是数字）
/turnrig status 1
```

#### 问题7: 会话ID格式错误

**症状**: 添加监听或目标时提示格式错误

**常见错误格式**:
- ❌ `123456789` (纯数字)
- ❌ `群聊123456789` (没有空格)

**正确格式**:
- ✅ `群聊 123456789` (有空格)
- ✅ `私聊 987654321` (有空格)

**解决方案**:
```bash
# 使用正确格式添加监听
/turnrig monitor 1 群聊 123456789

# 或使用简化命令在目标群中执行
/tr add 1
```

#### 问题8: 配置文件损坏

**症状**: 插件启动失败或功能异常

**解决方案**:
1. 删除配置文件让插件重新创建：
   ```
   删除: data/plugins_data/astrbot_plugin_turnrig/config.json
   ```
2. 重启AstrBot
3. 重新配置任务

### 🔴 性能相关问题

#### 问题9: 消息处理过慢

**症状**: 大量消息时插件响应缓慢

**解决方案**:
1. 减少监听的群聊数量（建议单任务不超过10个）
2. 使用特定用户监听而非全群监听
3. 适当增加消息阈值减少转发频率
4. 定期清理过期数据：`/turnrig cleanup`

#### 问题10: 存储空间占用过多

**症状**: 插件数据文件很大

**解决方案**:
```bash
# 清理过期的消息ID记录
/turnrig cleanup 7

# 删除不需要的任务
/turnrig delete 任务ID
```

### 🔴 消息内容问题

#### 问题11: 图片无法转发

**症状**: 文字消息正常，图片消息丢失

**可能原因**:
1. 图片下载失败
2. 临时文件清理过快
3. 网络连接问题

**解决方案**:
1. 检查网络连接
2. 增加图片下载重试次数（需要代码修改）
3. 检查临时文件目录权限

#### 问题12: 转发消息格式异常

**症状**: 转发的消息格式与原消息不同

**说明**: 这是正常现象，插件会将消息转换为标准格式以确保兼容性

### 🔴 特殊功能问题

#### 问题13: 嵌套转发消息不显示

**症状**: QQ中看不到转发消息的内容

**说明**: 
- 这是QQ新版本的安全机制
- API转发的消息在新版QQ中可能不显示
- 手动转发的消息正常显示
- 这不是插件问题，而是平台限制

#### 问题14: 群内特定用户监听无效

**症状**: 设置了特定用户监听但没有效果

**排查步骤**:
```bash
# 检查配置
/turnrig status 任务ID

# 确认用户ID和群ID正确
/turnrig adduser 任务ID 群号 QQ号
```

**注意事项**:
- 确保QQ号格式正确（纯数字）
- 确保群号格式正确
- 只监听特定用户时不要同时设置全群监听

## 🔍 日志诊断

### 查看插件日志

插件的详细日志会记录在AstrBot的日志文件中，可以帮助诊断问题：

**重要日志信息**:
- 任务创建和配置变更
- 消息处理流程
- 错误信息和异常
- 网络请求状态

**常见日志模式**:
```
[INFO] 转发侦听器插件初始化完成 ✅
[INFO] 已加载 2 个转发任务喵～ 📊
[ERROR] 处理消息时出错喵: [错误详情] 😿
[WARNING] 清理临时文件失败喵: [文件路径] 😿
```

### 开启调试模式

如果需要更详细的日志信息，可以修改AstrBot的日志级别。

## 🛠️ 高级诊断命令

### 检查插件状态
```bash
/turnrig list        # 查看所有任务
/turnrig status      # 查看缓存状态
/turnrig listbots    # 查看机器人过滤列表
```

### 清理和重置
```bash
/turnrig cleanup 3   # 清理3天前的数据
/turnrig disable 1   # 临时禁用任务
/turnrig enable 1    # 重新启用任务
```

### 测试转发功能
```bash
/turnrig forward 1   # 手动触发转发
```

## 📞 寻求帮助

如果以上解决方案都无法解决问题，可以：

### 收集信息
在报告问题时，请提供：
1. 具体的错误信息
2. 执行的命令
3. 预期的结果 vs 实际结果
4. 相关的日志信息
5. AstrBot版本和插件版本

### 联系方式
- GitHub: [提交Issue](https://github.com/WentUrc/astrbot_plugin_turnrig/issues)
- 在Issue中使用提供的模板

### 临时解决方案

**重置插件**:
1. 停止AstrBot
2. 删除插件数据目录: `data/plugins_data/astrbot_plugin_turnrig/`
3. 重启AstrBot
4. 重新配置所有任务

**降级使用**:
1. 使用更保守的配置（更高的消息阈值）
2. 减少监听的群聊数量
3. 使用特定用户监听代替全群监听

## 🔧 预防性维护

### 定期维护任务
1. 每周清理过期数据: `/turnrig cleanup 7`
2. 检查任务状态: `/turnrig list`
3. 清理不需要的任务: `/turnrig delete 任务ID`

### 性能优化建议
1. 监听源数量控制在10个以内
2. 合理设置消息阈值（10-20）
3. 定期检查和清理无用配置
4. 避免循环转发配置

### 备份重要配置
定期备份配置文件：
```
data/plugins_data/astrbot_plugin_turnrig/config.json
```

---

记住，大多数问题都有简单的解决方案喵♡～ 如果遇到问题，先检查基础配置，再考虑复杂的故障排除步骤！✨ 
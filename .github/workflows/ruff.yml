name: Lint with Ruff

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# å·¥ä½œæµçš„æ˜¾å¼æƒé™è®¾ç½®
permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # ä¸ºæŽ¨é€å’ŒPRäº‹ä»¶ä½¿ç”¨æ­£ç¡®çš„å¼•ç”¨
        ref: ${{ github.head_ref || github.ref }}
        token: ${{ secrets.PINE_LN_PAT || secrets.GITHUB_TOKEN }}
        # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ä»¥ä¾¿æ›´å¥½åœ°è¿›è¡Œgitæ“ä½œ
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5  # æ›´æ–°åˆ° v5
      with:
        python-version: '3.x'
        cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–

    - name: Install Ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run Ruff Check (Lint Only)
      id: ruff_check
      run: |
        echo "Running Ruff check..."
        if ruff check . --output-format=github; then
          echo "lint_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… No linting issues found!"
        else
          echo "lint_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ Linting issues found!"
        fi
      continue-on-error: true

    - name: Run Ruff Format Check
      id: ruff_format
      run: |
        echo "Checking code formatting..."
        if ruff format --check .; then
          echo "format_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Code formatting is correct!"
        else
          echo "format_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ Code formatting issues found!"
        fi
      continue-on-error: true

    # ä»…å¯¹æ‹‰å–è¯·æ±‚å°è¯•è‡ªåŠ¨ä¿®å¤
    - name: Auto-fix issues (PR only)
      if: github.event_name == 'pull_request' && (steps.ruff_check.outputs.lint_passed == 'false' || steps.ruff_format.outputs.format_passed == 'false')
      run: |
        echo "Attempting to auto-fix linting and formatting issues..."
        
        # ä¿®å¤ä»£ç æ£€æŸ¥é—®é¢˜
        ruff check --fix .
        
        # ä¿®å¤æ ¼å¼é—®é¢˜
        ruff format .
        
        echo "Auto-fix completed!"

    - name: Check for changes after auto-fix
      if: github.event_name == 'pull_request'
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes needed after auto-fix!"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes were made during auto-fix"
          echo "Files changed:"
          git diff --name-only
        fi

    - name: Commit and push auto-fixes
      if: github.event_name == 'pull_request' && steps.check_changes.outputs.has_changes == 'true'
      run: |
        # é…ç½® git
        git config --local user.name 'IGCrystal-Ghost'
        git config --local user.email 'cacheigcrystal@gmail.com'
        
        # æš‚å­˜æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # åˆ›å»ºæäº¤
        git commit -m "ðŸ¤– Auto-fix: Resolve linting and formatting issues
        
        - Fixed linting issues with ruff check --fix
        - Fixed formatting issues with ruff format
        - Automated by GitHub Actions"
        
        # æŽ¨é€æ›´æ”¹
        echo "Pushing changes to ${{ github.head_ref }}..."
        if git push origin HEAD:${{ github.head_ref }}; then
          echo "âœ… Successfully pushed auto-fixes!"
        else
          echo "âŒ Failed to push changes. This might be due to:"
          echo "  - Branch protection rules"
          echo "  - Insufficient token permissions"
          echo "  - Conflicts with recent commits"
          echo ""
          echo "You may need to manually apply these fixes:"
          echo "  ruff check --fix ."
          echo "  ruff format ."
          exit 1
        fi

    # æœ€ç»ˆæ£€æŸ¥ - å¦‚æžœé—®é¢˜ä»ç„¶å­˜åœ¨åˆ™ä½¿å·¥ä½œæµå¤±è´¥
    - name: Final validation
      run: |
        echo "Running final validation..."
        
        # æ£€æŸ¥ä»£ç æ£€æŸ¥
        if ! ruff check . --output-format=github; then
          echo "âŒ Linting issues still remain!"
          exit 1
        fi
        
        # æ£€æŸ¥æ ¼å¼
        if ! ruff format --check .; then
          echo "âŒ Formatting issues still remain!"
          exit 1
        fi
        
        echo "âœ… All checks passed!"

    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“‹ Ruff Linting Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.ruff_check.outputs.lint_passed }}" == "true" ]]; then
          echo "âœ… **Linting**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Linting**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.ruff_format.outputs.format_passed }}" == "true" ]]; then
          echo "âœ… **Formatting**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Formatting**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
          echo "ðŸ¤– **Auto-fixes**: Applied and committed" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "âœ¨ **Auto-fixes**: No changes needed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Auto-fixes**: Only available on pull requests" >> $GITHUB_STEP_SUMMARY
        fi

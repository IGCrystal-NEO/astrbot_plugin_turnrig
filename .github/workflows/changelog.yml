name: Update Changelog

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate changelog for'
        required: true
        type: string

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Get previous version
        id: get_previous_version
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬ä¹‹å‰çš„æœ€æ–° tag
          VERSION="${{ github.event.inputs.version || github.event.release.tag_name }}"
          
          # è·å–æ‰€æœ‰æ ‡ç­¾ï¼Œæ’é™¤å½“å‰ç‰ˆæœ¬ï¼Œå–æœ€æ–°çš„
          PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -v "^${VERSION}$" | head -n1 || echo "")
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å‰ä¸€ä¸ªæ ‡ç­¾ï¼Œå°è¯•è·å–æœ€è€çš„æ ‡ç­¾ä½œä¸ºèµ·å§‹ç‚¹
          if [ -z "$PREVIOUS_TAG" ]; then
            FIRST_TAG=$(git tag -l --sort=version:refname | head -n1 || echo "")
            echo "previous_tag=$FIRST_TAG" >> $GITHUB_OUTPUT
            echo "is_first_release=true" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "is_first_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        run: |
          VERSION="${{ github.event.inputs.version || github.event.release.tag_name }}"
          PREVIOUS_VERSION="${{ steps.get_previous_version.outputs.previous_tag }}"
          IS_FIRST_RELEASE="${{ steps.get_previous_version.outputs.is_first_release }}"
          
          echo "Generating changelog for version: $VERSION"
          echo "Previous version: $PREVIOUS_VERSION"
          echo "Is first release: $IS_FIRST_RELEASE"
          
          if [ "$IS_FIRST_RELEASE" = "true" ] && [ -n "$PREVIOUS_VERSION" ]; then
            # ç¬¬ä¸€æ¬¡å‘å¸ƒä½†æœ‰æ ‡ç­¾ï¼Œä»ç¬¬ä¸€ä¸ªæ ‡ç­¾å¼€å§‹
            python scripts/generate_changelog.py "$VERSION" "$PREVIOUS_VERSION" HEAD
          elif [ -n "$PREVIOUS_VERSION" ]; then
            # æ­£å¸¸æƒ…å†µï¼Œä»ä¸Šä¸€ä¸ªç‰ˆæœ¬å¼€å§‹
            python scripts/generate_changelog.py "$VERSION" "$PREVIOUS_VERSION" HEAD
          else
            # å®Œå…¨æ²¡æœ‰æ ‡ç­¾ï¼Œç”Ÿæˆæ‰€æœ‰å†å²
            python scripts/generate_changelog.py "$VERSION" --all HEAD
          fi

      - name: Update metadata version
        if: github.event.inputs.version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # æ›´æ–° metadata.yaml ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/version: .*/version: \"$VERSION\"/" metadata.yaml

      - name: Commit and push
        if: github.event.inputs.version
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md metadata.yaml
          git commit -m "ğŸ“ƒ docs: update changelog for v${{ github.event.inputs.version }}" || exit 0
          git push

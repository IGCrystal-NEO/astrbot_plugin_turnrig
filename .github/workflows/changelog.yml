name: Update Changelog

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate changelog for'
        required: true
        type: string

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:      
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.PINE_LN_PAT || secrets.GITHUB_TOKEN }}
        ref: main  # æ˜ç¡®æŒ‡å®šæ£€å‡ºmainåˆ†æ”¯ï¼Œé¿å…detached HEADçŠ¶æ€
        persist-credentials: true  # ç¡®ä¿å‡­æ®æŒä¹…åŒ–

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Get previous version
      id: get_previous_version
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬ä¹‹å‰çš„æœ€æ–° tag
        VERSION="${{ github.event.inputs.version || github.event.release.tag_name }}"
        
        # è·å–æ‰€æœ‰æ ‡ç­¾ï¼Œæ’é™¤å½“å‰ç‰ˆæœ¬ï¼Œå–æœ€æ–°çš„
        PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -v "^${VERSION}$" | head -n1 || echo "")
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å‰ä¸€ä¸ªæ ‡ç­¾ï¼Œå°è¯•è·å–æœ€è€çš„æ ‡ç­¾ä½œä¸ºèµ·å§‹ç‚¹
        if [ -z "$PREVIOUS_TAG" ]; then
          FIRST_TAG=$(git tag -l --sort=version:refname | head -n1 || echo "")
          echo "previous_tag=$FIRST_TAG" >> $GITHUB_OUTPUT
          echo "is_first_release=true" >> $GITHUB_OUTPUT
        else
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "is_first_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate changelog
      run: |
        VERSION="${{ github.event.inputs.version || github.event.release.tag_name }}"
        PREVIOUS_VERSION="${{ steps.get_previous_version.outputs.previous_tag }}"
        IS_FIRST_RELEASE="${{ steps.get_previous_version.outputs.is_first_release }}"
        
        echo "Generating changelog for version: $VERSION"
        echo "Previous version: $PREVIOUS_VERSION"
        echo "Is first release: $IS_FIRST_RELEASE"
        
        if [ "$IS_FIRST_RELEASE" = "true" ] && [ -n "$PREVIOUS_VERSION" ]; then
          # ç¬¬ä¸€æ¬¡å‘å¸ƒä½†æœ‰æ ‡ç­¾ï¼Œä»ç¬¬ä¸€ä¸ªæ ‡ç­¾å¼€å§‹
          python scripts/generate_changelog.py "$VERSION" "$PREVIOUS_VERSION" HEAD
        elif [ -n "$PREVIOUS_VERSION" ]; then
          # æ­£å¸¸æƒ…å†µï¼Œä»ä¸Šä¸€ä¸ªç‰ˆæœ¬å¼€å§‹
          python scripts/generate_changelog.py "$VERSION" "$PREVIOUS_VERSION" HEAD
        else
          # å®Œå…¨æ²¡æœ‰æ ‡ç­¾ï¼Œç”Ÿæˆæ‰€æœ‰å†å²
          python scripts/generate_changelog.py "$VERSION" --all HEAD
        fi

    - name: Update metadata version
      if: github.event.inputs.version
      run: |
        VERSION="${{ github.event.inputs.version }}"
        # æ›´æ–° metadata.yaml ä¸­çš„ç‰ˆæœ¬å·
        sed -i "s/version: .*/version: \"$VERSION\"/" metadata.yaml

    - name: Create Pull Request
      if: github.event.inputs.version
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.PINE_LN_PAT || secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ“ƒ docs: update changelog for ${{ github.event.inputs.version }}"
        title: "ğŸ“ƒ Update changelog for ${{ github.event.inputs.version }}"
        body: |
          ## ğŸ“ƒ Changelog Update
          
          This PR updates the changelog and metadata for version `${{ github.event.inputs.version }}`.
          
          ### Changes:
          - âœ… Updated CHANGELOG.md with new version entries
          - âœ… Updated metadata.yaml version number
          
          ### Generated by:
          GitHub Actions workflow triggered manually
        branch: "changelog/update-${{ github.event.inputs.version }}"
        delete-branch: true
        draft: false

    - name: Direct commit for release
      if: github.event.release.tag_name
      run: |
        VERSION="${{ github.event.release.tag_name }}"
        # ç§»é™¤ç‰ˆæœ¬å·å¼€å¤´çš„ v å‰ç¼€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        CLEAN_VERSION=${VERSION#v}
        
        # ç¡®ä¿æˆ‘ä»¬åœ¨mainåˆ†æ”¯ä¸Š
        git checkout main
        git pull origin main
        
        # æ›´æ–° metadata.yaml ä¸­çš„ç‰ˆæœ¬å·
        sed -i "s/version: .*/version: \"$VERSION\"/" metadata.yaml
        
        git config --local user.email "Chrysanthemum@wenturc.com"
        git config --local user.name "Pine-Ln"
        git add CHANGELOG.md metadata.yaml
        git commit -m "ğŸ“ƒ docs: update changelog for v${CLEAN_VERSION}" || exit 0
        git push origin main
